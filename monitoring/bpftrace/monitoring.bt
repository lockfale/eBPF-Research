#!/usr/bin/env bpftrace

#include <linux/sched.h>

BEGIN
{
  printf("timestamp,pid,event,data\n");
}

tracepoint:syscalls:sys_enter_*
/pid == $1/
{
  time("%Y-%m-%d %H:%M:%S");
  printf(",%d,%s,%s\n", pid, probe, str(args->filename));
}

tracepoint:syscalls:sys_exit_*
/pid == $1/
{
  time("%Y-%m-%d %H:%M:%S");
  printf(",%d,%s,%d\n", pid, probe, args->ret);
}

kprobe:*
/pid == $1/
{
  time("%Y-%m-%d %H:%M:%S");
  printf(",%d,%s\n", pid, probe);
}